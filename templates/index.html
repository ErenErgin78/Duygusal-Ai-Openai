<!DOCTYPE html>
<html>
<head>
    <title>Duygu Chatbot</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { 
            --bg: #f5f5f5; 
            --text: #222; 
            --card-bg: #ffffff; 
            --surface: #fafafa; 
            --border: #ddd; 
            --muted: #666; 
            --primary: #007bff; 
            --primary-hover: #0056b3; 
            --on-primary: #ffffff; 
            --accent: #ffcc00; 
            --bubble-bg: #e9ecef; 
            --input-bg: #ffffff; 
            --matrix-color: #00aa55;
        }
        .dark { 
            --bg: #0f141a; 
            --text: #e6edf3; 
            --card-bg: #161b22; 
            --surface: #0d1117; 
            --border: #30363d; 
            --muted: #9da7b0; 
            --primary: #1f6feb; 
            --primary-hover: #255fbd; 
            --on-primary: #ffffff; 
            --accent: #f2c744; 
            --bubble-bg: #21262d; 
            --input-bg: #0d1117; 
            --matrix-color: #23d18b;
        }
        body { font-family: Arial, sans-serif; margin: 20px; background: var(--bg); color: var(--text); }
        #matrix-canvas { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .container { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .face-container { width: 220px; height: 260px; margin: 0 auto 20px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 50%; box-shadow: inset 0 10px 30px rgba(0,0,0,0.07), 0 4px 12px rgba(0,0,0,0.06); display: grid; place-items: center; overflow: hidden; padding: 8px; }
        .face-emoji { font-size: 96px; line-height: 1; transition: transform 200ms ease, opacity 200ms ease; white-space: nowrap; display: block; }
        .face-emoji.anim { transform: scale(0.85); opacity: 0.2; }
        .chat-box { height: 240px; border: 1px solid var(--border); padding: 12px; overflow-y: auto; margin-bottom: 10px; background: var(--surface); border-radius: 5px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; max-width: 75%; }
        .user { background: var(--primary); color: var(--on-primary); text-align: right; margin-left: auto; }
        .bot { background: var(--bubble-bg); color: var(--text); margin-right: auto; }
        .message pre { margin: 0; font-size: 14px; }
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 5px; background: var(--input-bg); color: var(--text); }
        .input-area button { padding: 10px 20px; background: var(--primary); color: var(--on-primary); border: none; border-radius: 5px; cursor: pointer; }
        .input-area button:hover { background: var(--primary-hover); }
        .stats { display: flex; gap: 20px; margin-top: 20px; }
        .stat-box { background: var(--bubble-bg); padding: 10px; border-radius: 5px; flex: 1; text-align: center; }
        h1 { color: var(--text); text-align: center; }
        .loading { color: var(--muted); font-style: italic; }
        pre { white-space: pre-wrap; word-break: break-word; }
        .controls { display: flex; justify-content: center; margin-bottom: 12px; }
        .next-btn { background: var(--accent); color: #222; border: none; border-radius: 20px; padding: 8px 16px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .next-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .disabled { opacity: 0.7; pointer-events: none; }
        .theme-btn { margin-left: 8px; background: var(--bubble-bg); color: var(--text); border: 1px solid var(--border); border-radius: 20px; padding: 8px 12px; cursor: pointer; }
        
        /* Responsive */
        @media (max-width: 768px) {
            body { margin: 12px; }
            .container { max-width: 100%; padding: 14px; }
            .face-container { width: 180px; height: 200px; padding: 6px; }
            .face-emoji { font-size: 72px; }
            .chat-box { height: 42vh; padding: 10px; }
            .message { max-width: 90%; }
            .input-area { flex-direction: column; gap: 8px; }
            .input-area button { width: 100%; }
            .stats { gap: 10px; }
        }
        
        @media (max-width: 420px) {
            h1 { font-size: 18px; }
            .face-container { width: 150px; height: 170px; padding: 6px; }
            .face-emoji { font-size: 56px; }
            .chat-box { height: 44vh; }
            .next-btn { padding: 6px 12px; }
        }
    </style>
    <script>
        // Step state for two-stage response
        let stepData = null; // { steps: [{mood, text}, {mood, text}], index: 0 }
        // Theme state
        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
            localStorage.setItem('theme', theme);
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            applyTheme(isDark ? 'light' : 'dark');
        }

        // Matrix rain animation
        let matrixCtx = null;
        let matrixCanvas = null;
        let matrixColumns = 0;
        let matrixDrops = [];
        let matrixFontSize = 16;
        let matrixInterval = 60; // ms per step (increase to slow down)
        let matrixLastTs = 0;
        const matrixChars = '01ABCDEFGHIJKLMNOPQRSTUVWXYZ„ÅÇ„ÅÑ„ÅÜ„Åà„ÅäÔΩ±ÔΩ≤ÔΩ≥ÔΩ¥ÔΩµ+-*/<>#$%&';

        function setupMatrix() {
            matrixCanvas = document.getElementById('matrix-canvas');
            if (!matrixCanvas) return;
            matrixCtx = matrixCanvas.getContext('2d');
            resizeMatrix();
            requestAnimationFrame(drawMatrix);
        }

        function resizeMatrix() {
            if (!matrixCanvas || !matrixCtx) return;
            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;
            matrixFontSize = Math.max(12, Math.floor(window.innerWidth / 90));
            matrixCtx.font = `${matrixFontSize}px monospace`;
            matrixColumns = Math.floor(matrixCanvas.width / matrixFontSize);
            matrixDrops = Array(matrixColumns).fill(0).map(() => Math.floor(Math.random() * matrixCanvas.height / matrixFontSize));
        }

        function drawMatrix(ts) {
            if (!ts) ts = performance.now();
            if (matrixLastTs === 0) matrixLastTs = ts;
            const delta = ts - matrixLastTs;
            if (delta < matrixInterval) {
                requestAnimationFrame(drawMatrix);
                return;
            }
            matrixLastTs = ts;
            if (!matrixCtx || !matrixCanvas) return;
            // Faint background for trail
            matrixCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#000000';
            matrixCtx.globalAlpha = 0.12;
            matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
            matrixCtx.globalAlpha = 1;

            const color = getComputedStyle(document.documentElement).getPropertyValue('--matrix-color').trim() || '#00ff88';
            matrixCtx.fillStyle = color;

            for (let i = 0; i < matrixColumns; i++) {
                const text = matrixChars.charAt(Math.floor(Math.random() * matrixChars.length));
                const x = i * matrixFontSize;
                const y = matrixDrops[i] * matrixFontSize;
                matrixCtx.fillText(text, x, y);
                if (y > matrixCanvas.height && Math.random() > 0.99) {
                    matrixDrops[i] = 0;
                }
                matrixDrops[i]++;
            }
            requestAnimationFrame(drawMatrix);
        }

        function extractFirstEmoji(text) {
            try {
                const regex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u;
                const m = text.match(regex);
                return m ? m[0] : null;
            } catch (e) {
                return null;
            }
        }

        function setFaceFromText(text) {
            const emoji = extractFirstEmoji(text) || 'üôÇ';
            const node = document.getElementById('face-emoji');
            if (node) {
                node.classList.add('anim');
                setTimeout(() => {
                    node.textContent = emoji;
                    node.classList.remove('anim');
                    fitFaceEmoji();
                }, 150);
            }
        }

        function fitFaceEmoji() {
            const container = document.querySelector('.face-container');
            const node = document.getElementById('face-emoji');
            if (!container || !node) return;
            const maxW = container.clientWidth - 16;
            const maxH = container.clientHeight - 16;
            let size = 96;
            node.style.fontSize = size + 'px';
            node.style.whiteSpace = 'nowrap';
            for (let i = 0; i < 12; i++) {
                const w = node.scrollWidth;
                const h = node.scrollHeight;
                if (w <= maxW && h <= maxH) break;
                size = Math.max(24, Math.floor(size * 0.9));
                node.style.fontSize = size + 'px';
            }
        }

        function extractJsonObject(text) {
            if (!text) return null;
            text = text.replace(/```json|```/g, '').trim();
            const start = text.indexOf('{');
            if (start === -1) return null;
            let depth = 0, inStr = false, esc = false, end = -1;
            for (let i = start; i < text.length; i++) {
                const ch = text[i];
                if (inStr) {
                    if (esc) { esc = false; }
                    else if (ch === '\\') { esc = true; }
                    else if (ch === '"') { inStr = false; }
                } else {
                    if (ch === '"') inStr = true;
                    else if (ch === '{') depth++;
                    else if (ch === '}') {
                        depth--;
                        if (depth === 0) { end = i; break; }
                    }
                }
            }
            if (end === -1) return null;
            const candidate = text.substring(start, end + 1);
            try { return JSON.parse(candidate); } catch (_) { return null; }
        }

        function disableInput(disabled) {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            if (input) input.disabled = disabled;
            if (btn) btn.disabled = disabled;
        }

        function showNextStep() {
            if (!stepData) return;
            if (stepData.index >= stepData.steps.length - 1) return;
            stepData.index += 1;
            const s = stepData.steps[stepData.index];
            if (window.__lastResponseSecondEmoji) {
                const node = document.getElementById('face-emoji');
                if (node) {
                    node.classList.add('anim');
                    setTimeout(() => { node.textContent = window.__lastResponseSecondEmoji; node.classList.remove('anim'); fitFaceEmoji(); }, 150);
                }
            } else {
                setFaceFromText(s.text);
            }
            addMessage(s.text, false);
            if (stepData.index >= stepData.steps.length - 1) {
                document.getElementById('next-btn').disabled = true;
                disableInput(false);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, true);
            input.value = '';
            addLoadingMessage();
            setFaceFromText('ü§î');
            disableInput(true);

            try {
                const resp = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await resp.json();
                removeLoadingMessage();

                if (data.error) {
                    addMessage('Hata: ' + data.error, false);
                    disableInput(false);
                    return;
                }

                // Debug b√∂l√ºmleri kaldƒ±rƒ±ldƒ±

                // Try parse JSON (ilk/ikinci ruh hali-cevap), fallback to plain text
                let steps = null;
                const j = extractJsonObject(data.response);
                if (j && j.ilk_ruh_hali && j.ilk_cevap && j.ikinci_ruh_hali && j.ikinci_cevap) {
                    steps = [
                        { mood: j.ilk_ruh_hali, text: j.ilk_cevap },
                        { mood: j.ikinci_ruh_hali, text: j.ikinci_cevap }
                    ];
                }

                if (steps) {
                    stepData = { steps, index: 0 };
                    // Show first (server-provided emoji preferred)
                    addMessage(steps[0].text, false);
                    if (data.first_emoji) {
                        const node = document.getElementById('face-emoji');
                        if (node) {
                            node.classList.add('anim');
                            setTimeout(() => { node.textContent = data.first_emoji; node.classList.remove('anim'); fitFaceEmoji(); }, 150);
                        }
                    } else {
                        setFaceFromText(steps[0].text);
                    }
                    const nextBtn = document.getElementById('next-btn');
                    nextBtn.disabled = false;
                    // second emoji cache for next step
                    window.__lastResponseSecondEmoji = data.second_emoji || null;
                } else {
                    // Plain text behavior
                    addMessage(data.response, false);
                    if (data.first_emoji) {
                        const node = document.getElementById('face-emoji');
                        if (node) {
                            node.classList.add('anim');
                            setTimeout(() => { node.textContent = data.first_emoji; node.classList.remove('anim'); fitFaceEmoji(); }, 150);
                        }
                    } else {
                        setFaceFromText(data.response);
                    }
                    disableInput(false);
                }

                if (data.stats) {
                    document.getElementById('req-count').textContent = data.stats.requests;
                }
            } catch (e) {
                removeLoadingMessage();
                addMessage('Baƒülantƒ± hatasƒ±: ' + e.message, false);
                setFaceFromText('üòµ');
                disableInput(false);
            }
        }

        function addMessage(content, isUser) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isUser ? 'user' : 'bot');
            messageDiv.innerHTML = '<pre>' + content + '</pre>';
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addLoadingMessage() {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot loading';
            messageDiv.id = 'loading-message';
            messageDiv.textContent = 'Model d√º≈ü√ºn√ºyor...';
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }
        window.addEventListener('resize', fitFaceEmoji);
        window.addEventListener('resize', resizeMatrix);
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(saved);
            fitFaceEmoji();
            setupMatrix();
        });
    </script>
    </head>
<body>
    <canvas id="matrix-canvas"></canvas>
    <div class="container">
        <h1>ü§ñ Duygu Chatbot (FastAPI)
            <button class="theme-btn" onclick="toggleTheme()">üåó Tema</button>
        </h1>
        <div class="face-container">
            <div id="face-emoji" class="face-emoji">üôÇ</div>
        </div>
        <div class="controls">
            <button id="next-btn" class="next-btn" onclick="showNextStep()" disabled>‚ñ∂ Sonraki</button>
        </div>
        <div id="chat-box" class="chat-box"></div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." onkeypress="handleKeyPress(event)">
            <button id="send-btn" onclick="sendMessage()">G√∂nder</button>
        </div>
        <div class="stats">
            <div class="stat-box">
                <strong>ƒ∞stekler</strong><br>
                <span id="req-count">0</span>
            </div>
        </div>
        
    </div>
</body>
</html>


